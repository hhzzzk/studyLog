# SS_9_networksecurity2

[TOC]





# IP spoofing

> 공격자가 자신의 출발지 ip 주소를 변경해서 위장하고 공격하는 기술이다.
>
> 스머프 어택 등에 사용

출발지 ip 주소를 바꿈 > 스머프 어택

raw 소켓 프로그래밍을 이용한 공격, 이런 건 대부분 관리자 권한 필요로 한다.



## SYN flooding

싱크 플루딩 공격은 DDOS 공격의 일종이다.

> 공격자가 여러 대의 컴퓨터나 봇넷을 사용해 목표 서버에 대량의 TCP 연결 요청 == SYN 패킷을 보내는 공격이다. 서버를 과부하시켜 정상 서비스를 중단시킨다.



공격자가 서버가 1초에 10명만 서비스 가능하다면 1초에 10개의 리퀘스트를 요청한다. **이런 게 Dos 공격이다.**

서버 관리자는 이런 공격을 막아야 하는데 오픈 서비스라 누군지 모른다.

**방어**

- 이를 해결하는 것이 Firewall 장비를 설치해 특정 소스 ip가 과도한 접속을 요청할 경우 방화벽이 해당 주소를 블럭하는 것이다.



만약 공격자가 이런 firewall을 인지해 1초에 1000개를 보내면 블럭되는 것을 알게 되면

500개만 보낸다. 이런 공격이 ddos, distributed한 것이다.

raw 소켓을 이용해 출발지 ip도 속여서 보내면 syn flooing 공격이다.

즉 여러 대의 컴퓨터나 IP를 사용해 대규모의 SYN 패킷을 분산시켜서 보낸다. 그러면 SYN Flooding 공격이 DDOS 공격으로 확장된 것이다.



## IP 스푸핑 대책

Ingress filtering : 외부 네트워크에서 내부 네트워크로 들어오는 패킷을 검사하고 필터링한다. 들어오는거!검사

Egress filtering : 내부 네트워크에서 외부로 나가는 패킷을 검사하고 필터링한다.

- 나가는 패킷의 출발지 주소가 우리 내부가 아니면 막는다.



## Session hijacking - TCP의 세션, ISN이용!!!!

IP 스푸핑의 한계?

![image](https://github.com/hhzzzk/studyLog/assets/67236054/cd5a3144-37ea-479e-8215-1f9a5f010226)

IP스푸핑은 출발지의 IP 주소를 속인다. 서버는 응답 패킷을 보낸다. 

응답 패킷을 보낼때 공격자가 속인 주소로 싱크 어크 패킷을 보낸다.

공격자가 이 패킷을 받고 싶은데 다른 곳으로 가게 된다. 



공격자가 서버에 치명적인 공격을 하고 싶다면

나의 IP주소는 스푸핑해서 속였는데 서버가 보내는 패킷을 받아서 보내야 공격가능한데 그럴 수가 없다.



그래서 등장한 세션 하이재킹

![image](https://github.com/hhzzzk/studyLog/assets/67236054/e1389286-1f22-4b82-a15f-37fd1f450647)

E가 공격자다. B는 정상사용자, 서버 관리자이다.

E는 B가 보낸 패킷처럼 IP 스푸핑해서 서버 A를 속이고 서버 A에 치명적인 공격을 하는 패킷을 보내고 싶다.



TCP에는 SEQ#, 시퀀스 넘버가 존재한다.

TCP 처음 연결될 때 최초의 시퀀스 넘버, ISN을 정하게 된다.

최초 통신에 A와 B는 ISN을 주고받게 된다.



패킷 헤더에 ISN 정보가 포함된다.

서버 A는 이 ISN 정보가 있어야 패킷을 받아줄 것이다.

- 그렇다면 공격자는 ISN을 예측해야 공격 패킷을 보낼 수 있다.

> 여기서의 세션 하이재킹의 세션은 TCP의 세션이다!!!!!!



**공격과정**

1. E가 IP 스푸핑 공격을 한다.
2. A,B가 TCP 연결, E는 B에게 DOS 공격을 해서 B가 정상적으로 패킷을 보낼 수 없도록 한다.
3. E가 ISN을 정확히 예측한다.

위의 3가지를 만족하면 세션 하이재킹이 가능하다.



## 세션 하이재킹 대책

옛날에는 ISN 생성이 쉬워서 공격자가 예측하기 쉬웠다.

이를 해결하기 위해 대책으로 RFC 1948 인터넷 표준 문서에서 TCP의 ISN 생성 방법을 안내한다.

> •ISN = M + F(sip, sport, dip, dport,\<some secret>)

- ISN을 생성할 때 M는 단순한 값이고
- F가 중요한게 이걸로 ISN에 랜덤성을 부여한다. 출발지의 ip,포트번호, 도착지의 ip, 포트번호에다가
  - some secret!!!!!!!!!!!!!!!!!!!!!!!!을 추가해서 F는 암호 해쉬 함수이다. SHA256 등의 해시 함수를 적용한다.
  - 이 some secret는 서버만 안다!!!!!!



그 밖에도 암호화된 패킷을 사용하거나 인증을 추가해 보안을 높일 수 있다.



## Injecting false routing information

라우팅 알고리즘에서 동적 라우팅은 라우터들끼리 정보를 주고받아 최적의 경로를 결정한다.

그러나 이 때 "라우터들끼리의 신뢰를 전제한다!!" 이를 공격자가 이용한다.

![image](https://github.com/hhzzzk/studyLog/assets/67236054/a6c87dc1-b5fb-472a-9eda-8615a5bc8f19)

라우터들 중 공격 라우터가 숨어있을 때 

이 라우터나 모든 네트워크가 홉이 자신가 1, 즉 자신과 붙어있는 라우터라고 속인다.

그렇게 되면 모든 패킷이 공격 라우터로 흘러간다.

> 이런 false routing 정보를 주입! injecting!!



즉 라우터의 신뢰성 문제가 발생한다.



## 대책

각 라우터에 공통의 비밀키를 해서 무결성을 체크하도록 메시지를 구성한다.

즉 h(m||k)와 m을 함께 보낸다!!!!!!!!!!!!!!!!!!!!!



## Port scan

포트 번호를 고정하고 IP를 변경하면서 찾기

IP주소를 알때 IP를 고정시키고 포트번호를 변경하면서 찾기

두 가지 방법 존재. 열려있는 포트를 찾기! 그래서 거기를 공격하는 방식

![img](https://velog.velcdn.com/images/3eung_h10n/post/e3301d27-7571-4093-b402-c211d083c435/image.png)

여기서 보면 TCP에 여러가지 플래그가 있다.

RST가 1이면 리셋 패킷이다. 해당 포트가 없다는 뜻으로 세션을 끊는다.

![image](https://github.com/hhzzzk/studyLog/assets/67236054/d0b0fb93-ae04-4f82-ab88-e3bdbe19d929)

이처럼 포트가 닫혀있으면 RST/ACK 패킷을 보내서 세션을 끊는다.



포트스캔탐지를 우회하는 방법에는

1. 공격자가 싱크받고 어크를 안보낸다. 로그를 안남긴다.
2. 공격자가 최초에 어크를 보낸다.
3. 존재하지 않는 패킷을 보낸다. 최초로 RST를 보낸다거나 전부 111111 또는 000000인 패킷보내거나



![image](https://github.com/hhzzzk/studyLog/assets/67236054/1329357d-8211-46f6-9651-dadbb50ea0e1)

![image](https://github.com/hhzzzk/studyLog/assets/67236054/0e02fadd-0973-4eaf-987f-8b881a4286ff)