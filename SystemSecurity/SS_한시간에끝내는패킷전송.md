# SS_한시간에끝내는패킷전송

## LAN1강

LAN : Local Area Network, 특정 지리적 위치의 네트워크 장치들이 서로 통신하도록 연결된 네트워크

![image](https://github.com/hhzzzk/studyLog/assets/67236054/619f3f8d-8d72-4972-8750-8fd5e5d02d5f)

- 3개의 LAN이 연결, 123이라 하자
- 1LAN은 192.168.161의 24비트가 같다. 이는 IP주소의 서브넷 마스크이다.
  - IP 주소는 32비트로 구성, 24비트의 서브넷 마스크는 보통 클래스 C네트워크를 나타내면 주소의 처음 3바이트가 네트워크 주소를 나타내고 나머지 1바이트가 호스트의 주소이다.
  - 클래스 C 네트워크는 IPv4 주소 공간에서 특정한 주소 범위를 나타내며, 일반적으로 24비트로 구성된 서브넷 마스크를 가진다.

![image](https://github.com/hhzzzk/studyLog/assets/67236054/4fb02703-8854-4c43-b296-747e8ed8a5f6)

1LAN에서 클라이언트가 서버에게 메세지를 보내면 서버가 메세지를 다시 반환하는 과정이 어떻게 이루어지는지 살펴보자.

- 같은 LAN 내의 장치기리 데이터 패킷 전달 방법

## 라우팅 테이블 Routing table

라우터나 다른 네트워크 장비가 패킷을 보낼 때 어느 방향으로 보내야 하는지 결정하는데 사용된다.

윈도우 파워쉘에서 "netstat -rn" 명령어 입력

![image](https://github.com/hhzzzk/studyLog/assets/67236054/2ec44d68-b4ec-4ee1-84c9-06a945ca59fd)

네트워크 목적지, 넷마스크, 게이트웨이 등이 있다.

## IP Routing

IP라우팅은 데이터 패킷이 출발지에서 목적지로 이동할 때 경로를 결정하는 프로세스이다.

라우터가 패킷의 최적 경로를 결정한다. 

## 라우팅 테이블의 정렬

longest prefix matching 알고리즘은 주어진 IP 주소에 대해 라우팅 테이블의 항목을 검색할 때 사용된다. 

- 가장 구체적인 매칭을 찾기 위해 라우팅 테이블 항목을 연속된 1의 개수에 따라 정렬한다.
- 즉 서브넷 마스크가 더 많은 1을 포함하는 경우에 우선순위가 높아진다.

![image](https://github.com/hhzzzk/studyLog/assets/67236054/0314ad20-f33d-40d6-9f92-408f300a25b2)

- 넷마스크가 전부 1인 경우가 255.255.255.255이다. 



## Lognest prefix matching 알고리즘



알고리즘이 동작하는 방식은 이 목적지 ip 주소와 (서브)넷마스크를 bitwise and 연산을 한다.

1과 비트와이즈하면 자기자신이 나올 것이고 4번의 경우 연산을 하면 목적지 주소와 같다. 4번 당첨

`게이트웨이는 다음으로 패킷을 보낼 주소다.`

해당 게이트웨이는 161.230 즉 자기 자신이다. 결국 자기자신에게 던지라는 이야기다.



## 이더넷

지금 해당 LAN은 이더넷 방식 쓰고 있다. 

자기 자신에게 패킷을 전달하는 것은 해당 PC가 속한 LAN에 패킷을 무작위로 다 던져라

그럼 받는 사람이 알아서 해결한다.

받아서 받은 사람이 목적지 IP 주소를 보고 그게 내 IP면 패킷을 accept한다.

- 이렇게 패킷을 브로드캐스트 방식으로 내가 속한 LAN의 모든 장비에 전달하는 방식으로 패킷을 뿌리는게 이더넷 방식이다. 4번 규칙이 당점돼기 때문에 이런 방식을 한다.
- 만약 7번 규칙이었다면 해당 게이트웨이 161.1에게만 패킷을 하나 전달한다.

> 게이트웨이가 자기 자신의 IP 주소일 경우 이더넷 방식으로 패킷을 브로드캐스트한다.



## LAN2강

클라이언트가 패킷을 생성하는데 해당 패킷에는

SMAC | dMAC | SIP | dIP |...

앞의 4개의 정보가 필요하다. S는 출발지 source고 d는 목적지다.

그런데 목적지의 MAC 주소를 알아내기 위한 방법이 필요하다.

이 때 사용하는 것이 ARP 프로토콜이다.



## ARP 프로토콜

Address Resolution Protocol

이더넷이나 TCPIP 네트워크에서 IP 주소를 물리적인 MAC 주소로 매핑하는 프로토콜이다.

ARP 프로토콜은 호스트가 목적지의 MAC 주소를 모를 때 사용된다. 

호스트는 ARP Request 패킷을 브로드캐스트해 LAN 상의 모든 장치에게 물어본다.

## 이더넷 + ARP

이더넷 통신에서 패킷을 보낼 때 일단 dMAC를 1로 채워서 48비트를 보낸다. 

즉 48비트가 전부 1이면 ARP Request 패킷이다.

해당 패킷을 받은 장비는 누가 이더뎃 프로토콜 규약에 의해, ARP 프로토콜로 MAC 주소를 찾는 ARP Request 패킷을 보냈구나.

목적지 IP 주소가 자기가 맞는 장비만이 ARP Request에 대답하는 ARP Reply 패킷을 보낸다.

ARP Reply 패킷에는 dMAC값을 채워서 보낸다. 이제 클라이언트는 이터넷 패킷을 완성할 수 있다.



## LAN3강

클라이언트와 서버가 다른 LAN 소속인 경우에 대해 알아보자

![](https://velog.velcdn.com/images/vpdrnls/post/a1b73afd-641f-4857-a250-731b20bc6b54/image.png)

목적지 ip인 dIP는 192.169.162.230이다

![image](https://github.com/hhzzzk/studyLog/assets/67236054/0314ad20-f33d-40d6-9f92-408f300a25b2)

다시 라우팅 테이블을 통해 넷마스크와 목적지 IP를 연산한 결과와 게이트웨이와 같은 규칙을 찾는다.

없으므로 디폴트값이 7번을 선택한다. 7번 규칙은 항상 성립한다.

7번 규칙은 게이트웨이가 192.168.161.1이다. 즉 클라이언트와 동일한 LAN의 게이트웨이다.

클라이언트는 이더넷 프레임에서 SMAC | dMAC | Sip | dip 를 채워야 하는데

dMAC를 누구로 해야 하는가. 바로 위에서 찾는 7번 규칙의 게이트웨이의 MAC를 찾아야 한다.

그건 그림상 LAN의 라우터의 것이다. 



그럼 ARP 리퀘스트 패킷을 뿌리는데 목적지 맥 주소 dMAC를 1로 채워서 브로드캐스트로 뿌린다.

이를 통해 LAN 라우터의 맥 주소를 알게 된다. 

클라이언트는 이더넷 패킷을 잘 채워서 브로드캐스트 한다.



## 라우터까지 왔다

![](https://velog.velcdn.com/images/vpdrnls/post/a1b73afd-641f-4857-a250-731b20bc6b54/image.png)



161.1 라우터는 패킷을 받았다. 라우터는 자신의 라우팅 테이블을 뒤져서 다시 또 넷마스크와 목적지와 longest prefix matching해서 규칙을 찾는다. 그렇게 오른쪽의 라우터에게 전달하도록 될 것이고 또 arp 하고 반복하는 것이다.

결국 절차가

1. 라우팅 테이블에서 롱기스트 프리픽스 매칭하고
2. 다음 MAC 주소를 찾는다. 모르면 ARP 리퀘스트 뿌리고 리플라이 받고 한다.
3. 반복한다.

패킷, 이더넷 프레임에서 SMAC | dMAC | Sip | dip

**출발 IP 주소와 목적지 IP 주소는 변하지 않고 MAC 주소는 계속 바뀐다.**